<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jesse's Toolkit</title>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.mini.min.js"></script>
    <style>
        /* Color definitions */
        :root {
            /* Light */
            --green50: #CDFBDD;
            --green100: #95EEB4;
            --green200: #12CB77;
            /* Default Brand Colour | Default color on Grey 900 */
            /* Dark */
            --green400: #00A45F;
            /* Default colour on white */
            --green600: #1B7C53;
            /* Hyperlink colour on white */
            --green900: #0A3833;
            /* Grey Scale */
            /* Light */
            --white: #FFFFFF;
            --grey25: #F8F9FA;
            --grey50: #ECEEF1;
            --grey100: #E1E4E9;
            --grey200: #C5CAD5;
            --grey400: #8C96A8;
            /* Dark */
            --grey600: #5A6376;
            --grey900: #323232;
            /* Dark background | copy */
        }

        /* Default font */
        :root {
            font-family: Euclid Circular, Arial, sans-serif;
            color: var(--grey900);
        }

        html,
        body {
            height: 99%;
            margin-left: 1em;
        }

        .page-container {
            min-height: calc(100% - 10px);
            display: flex;
            flex-direction: column;
        }

        section {
            flex: 1;
        }

        #modalBtn {
            position: absolute;
            top: 3%;
            right: 3%;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2;
            padding-top: 100px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            border-radius: 5px;
        }

        .close {
            color: #aaaaaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            margin-top: -6px;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        h1 {
            color: var(--green400);
        }

        h2 {
            margin-top: 0.4em;
            margin-left: 0.3em;
        }

        li {
            padding-top: 0.5em;
            padding-bottom: 0.5em;
        }

        .button {
            background-color: var(--green400);
            color: var(--white);
            font-weight: bold;
            border: none;
            border-radius: 50px;
            padding: 6px 9px;
        }

        .button:hover {
            background-color: var(--green200);
            cursor: pointer;
        }

        input[type="file"] {
            display: none;
        }

        #kpi-table {
            border-collapse: collapse;
            text-align: center;
            cursor: default;
            margin: 5px;
        }

        #kpi-table th,
        td {
            padding: 0.5em;
        }

        #kpi-table thead,
        #kpi-table tfoot {
            color: var(--white);
        }

        #kpi-table th,
        #kpi-table tbody,
        #kpi-table tfoot {
            /* Borders */
            border: 2px solid var(--white);
        }

        #kpi-table thead tr:first-child {
            /* Main Headers */
            background-color: var(--grey900);
        }

        #kpi-table thead tr:nth-child(2) {
            /* Sub Headers */
            background-color: var(--green600);
        }

        #kpi-table thead tr:nth-child(2) :hover {
            /* Sub Headers */
            background-color: var(--grey600);
            cursor: pointer;
        }

        #kpi-table tbody tr:nth-child(odd) {
            /* Odd rows */
            background-color: var(--green50);
        }

        #kpi-table tbody tr:nth-child(even) {
            /* Even rows */
            background-color: var(--green100);
        }

        #kpi-table tfoot {
            /* Totals row */
            background-color: var(--green400);
            font-weight: bold;
        }

        #kpi-table .rep {
            text-align: left;
        }

        #kpi-table .currency {
            text-align: right;
        }

        #kpi-table th:first-child,
        #kpi-table td:first-child {
            padding-left: 1em;
        }

        #kpi-table th:last-child,
        #kpi-table td:last-child {
            padding-right: 1em;
        }

        #screenshotBtn {
            padding: 6px 10px;
            background-color: var(--green200);
            margin: 0;
        }

        #screenshotBtn:hover {
            background-color: var(--green100);
        }

        #simswap {
            width: fit-content;
            padding: 1em;
            border: 1px var(--green900);
            border-style: solid;
        }

        #copyright {
            font-size: 0.5em;
            text-align: center;
            padding: 2px 0;
            margin: 2px;
        }

        footer {
            font-size: 0.8em;
            text-align: center;
            padding: 5px 0;
            margin: 4px;
        }
    </style>
</head>

<body>
    <div class="page-container">
        <header>
            <h1>Jesse's Toolkit</h1>
            <h3 class="version"></h3>
            <button id="modalBtn" class="button">HELP</button>
        </header>
        <div id="modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>How to run Jesse's Toolkit</h2>
                <ol>
                    <li>Log in to Pronto.</li>
                    <li>Go to Reporting Portal.</li>
                    <li>Open the 'Sales - Sales and Profit by Product Group' report.</li>
                    <li>Select the store warehouse and edit dates if required.</li>
                    <li>Click Finish and wait for the report to run.</li>
                    <li>At the top of the page, click on the play button and select Run as CSV. The file will download.
                    </li>
                    <li>On Jesse's Toolkit, click on Upload File and select the downloaded file.</li>
                    <li>Click on a header to order by that header. Click on the copy icon to copy the report to the
                        clipboard.</li>
                </ol>
            </div>
        </div>
        <section>
            <p>
                <label class="button">
                    <input type="file" id="file-input" accept=".tsv, .csv, .ods" title="">
                    UPLOAD SALES REPORT
                </label>
                <span id="file-selected" style="margin-left: 1em;"></span>
            </p>
            <div id="kpi" hidden>
                <button id="screenshotBtn" style="position: absolute; font-size: 1em;" hidden class="button">üóê</button>
                <div id="capture" style="display: inline-block">
                    <table id="kpi-table"></table>
                    <p id="copyright" hidden>Jesse's Toolkit <span class="version"></span></p>
                </div>
            </div>
            <div id="loan-audit" hidden>
                <h3>Oops - here's a sneak peak as to what's coming next in Jesse's Toolkit!</h3>
                <input type="text" id="scan" placeholder="Scan device">
                <h2>Available Devices</h2>
                <table id="loan-available">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>IMEI</th>
                            <th>Name</th>
                            <th>Scanned</th>
                            <th>Condition</th>
                            <th>(action required)</th>
                        </tr>
                    </thead>
                    <tbody id="av-tbody"></tbody>
                </table>
                <h2>Allocated Devices</h2>
                <table id="loan-allocated">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>IMEI</th>
                            <th>Name</th>
                            <th>Scanned</th>
                            <th>Contract due date</th>
                            <th>(action required)</th>
                        </tr>
                    </thead>
                    <tbody id="al-tbody"></tbody>
                </table>
            </div>
            <div id="simswap">
                <table>
                    <tr>
                        <td colspan="2">
                            <h2>SIM Swap Template Maker</h2>
                        </td>
                    </tr>
                    <tr>
                        <td>Full Name:</td>
                        <td><input type="text" oninput="nameChg(this.value)"></td>
                    </tr>
                    <tr>
                        <td>Contact person:</td>
                        <td>
                            <label for="accholder"><input type="radio" name="contact" id="accholder"
                                    onclick="contactChg('accholder')">Account
                                Holder</label>
                            <label for="authcontact"><input type="radio" name="contact" id="authcontact"
                                    onclick="contactChg('authcontact')">Authorised Contact (account
                                holder has been contacted)</label>
                        </td>
                    </tr>
                    <tr>
                        <td>ID Type:</td>
                        <td>
                            <select name="idtype" id="idtype" onchange="idtypeChg(this.value)">
                                <option value="" disabled selected>- Select ID -</option>
                                <option value="nzdl">NZ Drivers Licence</option>
                                <option value="nzpp">NZ Passport</option>
                                <option value="auspp">Australian Passport</option>
                                <option value="otherpp">Overseas Passport</option>
                                <option value="nzbc">NZ Birth Certificate & Bank Statement (1 month)</option>
                                <option value="coi">Certificate of Identity</option>
                                <option value="kac">Kiwi Access Card & Bank Statement (1 month)
                                </option>
                                <option value="18p">18+ Card & Bank Statement (1 month)</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>ID'd by:</td>
                        <td>
                            <label for="pin"><input type="radio" name="pin" id="pin" onclick="pinChg('pin')">PIN</label>
                            <label for="secq"><input type="radio" name="pin" id="secq" onclick="pinChg('secq')">Security
                                Questions</label>
                            <label for="otp"><input type="radio" name="pin" id="otp" onclick="pinChg('otp')">OTP (Prepay only)</label>
                        </td>
                    </tr>
                    <tr id="secquestions" hidden>
                        <td>
                            <label for="oa"><input type="radio" name="questiontoggle" id="oa" onclick="secqChg('oa')"
                                    checked>On
                                account</label><br>
                            <label for="pp"><input type="radio" name="questiontoggle" id="pp"
                                    onclick="secqChg('pp')">Prepay</label>
                        </td>
                        <td>
                            <label class="oaq"><input type="checkbox" onchange="editTemplate()" value="Tenure">How long
                                have you
                                had this mobile number/connection?<br></label>
                            <label class="oaq"><input type="checkbox" onchange="editTemplate()"
                                    value="Num called last 2 days">Can
                                you tell me a number that you have called in the last 2 days and they have
                                answered.<br></label>
                            <label class="oaq"><input type="checkbox" onchange="editTemplate()"
                                    value="Payment Method">What method
                                do you usually use to pay your account?<br></label>
                            <label class="oaq"><input type="checkbox" onchange="editTemplate()"
                                    value="Most recent payment on account">What was the most recent payment amount on
                                your
                                account?<br></label>
                            <label class="oaq"><input type="checkbox" onchange="editTemplate()"
                                    value="Last call to One NZ/Details of Call">When did you last call us and what did
                                you
                                discuss?</label>

                            <label class="ppq" hidden><input type="checkbox" onchange="editTemplate()"
                                    value="Last topup date & value">When did you last top up your number and what was
                                the top up
                                value?<br></label>
                            <label class="ppq" hidden><input type="checkbox" onchange="editTemplate()"
                                    value="Last 4 Digits Credit Card">What are the last four digits of the credit card
                                registered on
                                your ‚ÄòMy One NZ‚Äô account (if you have one) or on your account<br></label>
                            <label class="ppq" hidden><input type="checkbox" onchange="editTemplate()"
                                    value="Monthly Bundle-Min/Data/Txt">What is your monthly bundle of minutes, txt‚Äôs
                                and
                                data?<br></label>
                            <label class="ppq" hidden><input type="checkbox" onchange="editTemplate()"
                                    value="Tenure">How long have
                                you had this mobile number/connection?<br></label>
                            <label class="ppq" hidden><input type="checkbox" onchange="editTemplate()"
                                    value="Num called last 2 days">Can you tell me a number that you have called in the
                                last 2 days
                                and they have answered.</label>
                        </td>
                    </tr>
                    <tr>
                        <td>Swap reason:</td>
                        <td><input type="text" oninput="reasonChg(this.value)"></td>
                    </tr>
                    <tr>
                        <td>Approved by:</td>
                        <td><input type="text" oninput="approverChg(this.value)"></td>
                    </tr>
                    <tr>
                        <td colspan="2"><textarea disabled id="template" rows="10" cols="80">
Full name:
Acc Holder/Auth Contact:
ID Type:
ID'd by:
Swap reason:
Approved by:
                        </textarea><br>
                            Character count: <span id="charcount">79</span>/250<span id="seccount"></span><br><br>
                            <button id="copytext" onclick="copyToClipboard()" disabled>Copy to clipboard</button>

                        </td>

                    </tr>
                </table>
                <br>

            </div>
            <pre id="output"></pre>
        </section>
        <footer>Created by Jesse Tiu 2025. <a href="mailto:jesse.tiu@one.nz">jesse.tiu@one.nz</a></footer>
    </div>
    <script>

        // Version Info
        const version = "v2.0";
        const versionElements = document.getElementsByClassName("version");
        for (let i = 0; i < versionElements.length; i++) {
            const v = document.createTextNode(version);
            versionElements[i].appendChild(v);
        }

        // Tutorial Modal
        var modal = document.getElementById("modal");
        var btn = document.getElementById("modalBtn");
        var span = document.getElementsByClassName("close")[0];

        btn.onclick = function () {
            modal.style.display = 'block';
        }

        span.onclick = function () {
            modal.style.display = 'none';
        }

        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // File input
        document.getElementById("file-input").addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                switch (file.type) {
                    case "text/csv": // If file is CSV, output KPI report
                        document.getElementById("kpi").hidden = false;
                        document.getElementById("loan-audit").hidden = true;
                        reader.onload = function (e) {
                            const text = e.target.result;
                            rawData = readTSV(text);

                            getRawReport(rawData);
                            displayTable(prepareReport()); // Run the script
                        };
                        reader.readAsText(file);
                        break;
                    case "application/vnd.oasis.opendocument.spreadsheet": // If file is ODS, output Loan Audit
                        document.getElementById("kpi").hidden = true;
                        document.getElementById("loan-audit").hidden = false;
                        reader.onload = function (e) {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });

                            // Get the first sheet name
                            const sheetName = workbook.SheetNames[0];

                            // Get the data from the first sheet
                            const sheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(sheet);

                            displayAudit(jsonData);
                        }
                        reader.readAsArrayBuffer(file);
                        break;
                }
                document.getElementById("simswap").hidden = true;
            }
        });
    </script>
    <script>
        // ------------------------------------------------------------------------------------------------------------------------------
        // KPI TRACKER

        // Fields that may want to be changed

        // IDs of all the columns calculated
        const d = {
            rep: "Rep",
            gp: "Gross Profit",
            gm: "Gen Merch",

            coa: "Con OA",
            cfab: "Con FAB",

            boa: "Bus OA",
            bfab: "Bus FAB",

            p2p: "P2P",
            rs: "Resigns",

            ict: "ICT",
            dev: "Devices",
            accs: "Accs",
            trend: "Trend",
            pp: "Prepay",
            oneup: "One Up",
            topup: "Top-ups",
            bills: "Bills",

            com: "Commission"
        };

        const headers = [ // Change these to change the headers.
            {
                "heading": "",
                "subHeadings": ["rep"]
            },
            {
                "heading": "Legends",
                "subHeadings": ["coa", "boa", "cfab", "bfab", "oneup", "gm"]
            }, {
                "heading": "GP",
                "subHeadings": ["gp"]
            }, {
                "heading": "Connections",
                "subHeadings": ["p2p", "rs", "ict"]
            }, {
                "heading": "Other",
                "subHeadings": ["dev", "accs", "trend", "bills", "topup", "pp", "com"]
            }
        ];

        const commission = { // Taken from most recent One Rate Card (Sept 2025)

            // Only these four metrics need calculating, as the report generated has the com amt in the gp field
            dev: 0.05, // device (as a %)
            gm: 0.1, // gen merch (as a %)
            pp: 2, // prepay (including travel)
            oneup: 5, // one upgrade


            fbb: 13, // consumer fixed broadband
            fbbrs: 6.5, // consumer fixed broadband resign
            busifbb: 20, // business fixed broadband
            busifbbrs: 6.5, // business fixed broadband resign
            wbb: 13, // wireless broadband
            wbbrs: 6.5, // wireless broadband resign

            companion: 7.5, // companion plan
            companionrs: 0, // companion plan resign
            p2p: 3, // postpay entry

            // endless data plans 
            edsmall: 4,
            edsmallrs: 1,
            edmedium: 7.5,
            edmediumrs: 1,
            edlarge: 12,
            edlargers: 5,
            oneplan: 20,
            oneplanrs: 7,

            // Business/ICT
            tollfree: 10,
            webex: 10,
            multitxt: 15,
            saas: 5, // M365 and Business Trend Micro
            mcd: 5, // IoT Managed Connectivity Data
            payg: 2, // IoT Pay as you Go Data Plan
            assets: 10, // IoT Asset Management

            watch: 5, // Apple or Samsung Watch

        };

        let sortColumn = 'gp'; // Change this variable to change the row sort. Currently set to gp.

        const dollarValues = ["gp", "gm", "com"];


        let rawData = [];
        let processedData = {};

        // quick save subheadings from the headings object
        const subHeadings = getSubHeadings(headers);
        function getSubHeadings(headers) {
            let subHeadings = [];
            headers.forEach(header => {
                header.subHeadings.forEach(subHeading => {
                    subHeadings.push(subHeading);
                });
            });
            return subHeadings;
        }

        // When downloading a CSV report from the reporting portal, it actually comes in a tsv, not a csv. So process it as a tsv.
        function readTSV(tsvText) {
            const rows = tsvText.split("\n").map(row => row.split("\t"));
            const headers = rows.shift();
            return rows.map(row => {
                let obj = {};
                row.forEach((cell, index) => {
                    obj[headers[index]] = cell.trimEnd();
                });
                return obj;
            });
        }

        function newReportLine(rep) {
            let rl = {};
            Object.keys(d).forEach(key => {
                if (key == 'rep') {
                    rl[key] = rep;
                } else {
                    rl[key] = 0;
                }
            })
            return rl;
        }

        function getRawReport(data) {
            let report = {};
            // Read the file and save the data into rawReport
            data.forEach(row => {
                let rep = row['Order Rep Name'];
                let code = row['Item Code'];
                let rrp = row['Recommended Retail Price'];
                let gp = parseFloat(row['Shipped GP']);
                let qty = parseInt(row['Shipped Quantity']);

                if (qty == 0 && rrp == 0) return; // Skip if there's nothing to count
                if (rep == undefined || rep == "Click N Collect") return; // Skip if the transaction has no rep or is C&C
                if (rrp != 0 && qty > 0 && gp < 0) return; // Skip if transaction is a transfer or write-off
                if (code.includes("-NOADDON") || code.includes("-ADD-VO")) return; // Skip if the transaction is a 'no addon' line or a VOIP/VOLTE addon // will need adjustment

                if (rrp == 0 && !row['Product Group'].includes("Top Up")) qty *= -1; // If it's a plan, invert the quantity

                // Create a new line on the report for each new rep
                if (report[rep] == null) {
                    report[rep] = newReportLine(rep);
                }

                // Add to report
                switch (row['Product Group']) {

                    //// Plans (quantities are negative in the report)

                    // Consumer Plans
                    case 'ConsNC Voice Smart Data': // Consumer New Connect
                        report[rep].coa += qty;
                        report[rep].gp += gp * 5;
                        report[rep].com += gp;
                        report[rep].plangp += gp * 5;
                        break;
                    case 'ConsPP Voice Smart Data PPN': // Consumer P2P
                        report[rep].p2p += qty;
                        report[rep].gp += gp * 5;
                        report[rep].com += gp;
                        report[rep].plangp += gp * 5;
                        break;
                    case 'ConsRS Voice Smart Data': // Consumer Resign
                        report[rep].rs += qty;
                        report[rep].gp += gp * 5;
                        report[rep].com += gp;
                        report[rep].plangp += gp * 5;
                        break;

                    // Business Plans
                    case 'BussNC Voice Smart Data': // Business New Connect
                    case 'BussNC Bundle Add-on Bundle':
                    case 'BussNC Bundle IOT':
                    case 'BussNC Data MBB':
                        report[rep].boa += qty;
                        report[rep].gp += gp * 5;
                        report[rep].com += gp;
                        report[rep].plangp += gp * 5;
                        break;
                    case 'BussPP Voice Smart Data PPN': // Business P2P
                        report[rep].p2p += qty;
                        report[rep].gp += gp * 5;
                        report[rep].com += gp;
                        report[rep].plangp += gp * 5;
                        break;
                    case 'BussRS Data MBB': // Business Resign
                    case 'BussRS Voice Smart Data':
                        report[rep].rs += qty;
                        report[rep].gp += gp * 5;
                        report[rep].com += gp;
                        report[rep].plangp += gp * 5;
                        break;

                    // Consumer FAB / BATs
                    case 'ConsNC FAB HM BB': // Consumer FAB New
                        report[rep].cfab += qty;
                        report[rep].gp += gp * 5;
                        report[rep].com += gp;
                        report[rep].plangp += gp * 5;
                        break;
                    case 'ConsRS FAB HM BB': // Consumer FAB Resign
                        report[rep].rs += qty;
                        report[rep].gp += gp * 5;
                        report[rep].com += gp;
                        report[rep].plangp += gp * 5;
                        break;

                    // Business FABs
                    case 'BussNC FAB WK BB': // Business FAB New
                        report[rep].bfab += qty;
                        report[rep].gp += gp * 5;
                        report[rep].com += gp;
                        report[rep].plangp += gp * 5;
                        break;
                    case 'BussRS FAB WK BB': // Business FAB Resigns
                        report[rep].rs += qty;
                        report[rep].gp += gp * 5;
                        report[rep].com += gp;
                        report[rep].plangp += gp * 5;
                        break;

                    // ICT // Don't include GP but the GP column contains the commission
                    case 'BussNC ICT':
                        report[rep].ict -= qty;
                        report[rep].com += gp;
                        break;

                    //// Sales

                    // Devices
                    case 'Live HSDPA':
                    case 'Business HSDPA':
                    case 'Tablet':
                        report[rep].dev += qty;
                        report[rep].gp += gp;
                        break;
                    case 'CST Device':
                        report[rep].dev += qty;
                        report[rep].gp += gp;
                        report[rep].com += commission.dev * gp + commission.watch * qty;
                        break;

                    // Accessories - counts towards GM
                    case 'CST Accessories':
                    case 'Adapters':
                    case 'Bluetooth Headset':
                    case 'Bundles':
                    case 'Cases':
                    case 'Chargers':
                    case 'Entertainment and Gaming':
                    case 'Holders/Cradles':
                    case 'Memory':
                    case 'Screen Protectors':
                    case 'Other':
                        report[rep].accs += qty;
                        report[rep].gp += gp;
                        report[rep].gm += gp;
                        report[rep].com += commission.gm * gp;
                        break;

                    // Trend - counts towards GM (but not accessory qty)
                    case 'Antivirus 1 Year Subscription':
                    case 'Antivirus 2 Year Subscription':
                    case 'Antivirus 3 Year Subscription':
                    case 'Antivirus - Prepay':
                        report[rep].trend += qty;
                        report[rep].gp += gp;
                        report[rep].gm += gp;
                        report[rep].com += commission.gm * gp;
                        break;

                    // Prepay
                    case 'Prepay':
                        report[rep].pp += qty;
                        report[rep].gp += gp;
                        report[rep].com += qty * commission.pp;
                        break;

                    // One Upgrade and IFP
                    case 'IFP Commission Line Group':
                        if (code == 'IFP-UPGRADEADD') {
                            report[rep].oneup += qty;
                            report[rep].com += qty * commission.oneup;
                        }
                        if (code == 'IFP-COMM') {  // This line shows up on Sisense calculations, but is not part of commission. We need to revisit this at a later date.
                            report[rep].gp += gp * 5;
                        }
                        break;

                    //// Topups and Bill payments

                    // Prepay topups - don't count towards GP
                    case 'Prepay Mobile Top Up':
                    case 'Prepay Direct Top Up':
                        report[rep].topup += qty;
                        break;

                    // Bill payments - don't count towards GP
                    case 'Mobile On Account Bill Payment':
                        report[rep].bills -= qty; // Bill payments end up as negative cos they have 0 GP and look like plans
                        break;

                    // These are IFP roundoffs (couple of cents per transaction from IFP calculations)
                    case 'MDP':
                        report[rep].gp += gp;
                        break;

                    // Everything else that can be ignored
                    case '':
                    case 'Unspecified':
                    case 'Plan Kits':
                    case 'Promotional Phone Rebate':
                    case 'Promotional Data Device Rebate':
                    case 'Terminal Device Rebates':
                    case 'Repair Fee':
                    case 'Online Vouchers':
                    case 'Vodafone Vouchers Retail':
                    case 'Excess Rebate':
                    case 'Phone Upgrade Redeem Fee':
                    case 'Service Fee':
                        break;

                    // If it's something unaccounted for, show error message
                    default:
                        alert('Please contact the developer with the following error:\n\nCould not process product group: ' + row['Product Group']);
                        break;
                }
            });
            processedData = report;
        }

        // Add totals and format currencies
        function prepareReport() {
            let preparedData = {};

            // Create a 2d array with all the data
            let preparedTable = [];
            let totalsLine = [];

            Object.values(processedData).forEach(row => {
                let tableLine = [];
                headers.forEach(header => {
                    header.subHeadings.forEach(subHeading => {
                        tableLine.push(row[subHeading]);

                    });
                });
                preparedTable.push(tableLine);
            });

            preparedTable = sortBy(preparedTable); // Sort table

            // Add totals
            preparedTable.forEach(line => {
                for (let index = 0; index < line.length; index++) {
                    if (subHeadings[index] == 'rep') {
                        totalsLine[index] = 'Totals';
                    } else {
                        if (!totalsLine[index]) totalsLine[index] = 0;
                        totalsLine[index] += line[index];
                    }
                }
            });
            preparedTable.push(totalsLine); // Add the totals line to the end of the array

            return preparedTable;
        }

        // Sort 2d array by given sortColumn (declared at the top)
        function sortBy(table) {
            let index = subHeadings.indexOf(sortColumn);
            let alpha = subHeadings.indexOf("rep");
            let t1 = table.sort((a, b) => { // Sort alphabetically first so it displays ties in alphabetical order
                if (a[alpha] < b[alpha]) return -1;
                if (a[alpha] > b[alpha]) return 1;
                return 0;
            });
            if (sortColumn == alpha) return t1; // If sortColumn is rep, then leave it. If not, sort according to what it is.
            return t1.sort((a, b) => {
                return b[index] - a[index]; // Assumes no other field is a string.
            });
        }

        // Create the html table
        function displayTable(data) {
            const table = document.getElementById("kpi-table");
            table.innerHTML = "";

            if (!Object.keys(data).length) return; // If there's no data, do nothing

            //// Headers
            const thead = document.createElement("thead");

            // Big headers
            const headerRow = document.createElement("tr");
            headers.forEach(header => {
                const heading = document.createElement("th");
                heading.textContent = header.heading;
                heading.colSpan = header.subHeadings.length;
                headerRow.appendChild(heading);
            });
            thead.appendChild(headerRow);

            // Little headers
            const subHeaderRow = document.createElement("tr");
            subHeadings.forEach(subHeading => {
                const subHeader = document.createElement("th");
                subHeader.textContent = d[subHeading];
                subHeader.className = subHeading;
                subHeader.onclick = function () {
                    if (sortColumn != this.className) { // Make the subheaders sorting buttons
                        sortColumn = this.className;
                        displayTable(prepareReport());
                    }
                }
                subHeaderRow.appendChild(subHeader);
            });
            thead.appendChild(subHeaderRow);

            table.appendChild(thead);

            // Body (main data)
            const tbody = document.createElement("tbody");
            for (let row = 0; row < data.length - 1; row++) { // skip the last row cos it has the totals
                const tr = document.createElement("tr");
                for (let col = 0; col < data[row].length; col++) {
                    const td = document.createElement("td");
                    td.textContent = data[row][col];
                    td.className = subHeadings[col];
                    if (dollarValues.includes(subHeadings[col])) td.classList.add("currency");
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
            table.appendChild(tbody);

            // Footer (totals)
            const tfoot = document.createElement("tfoot");
            const tr = document.createElement("tr");
            for (let col = 0; col < subHeadings.length; col++) {
                const td = document.createElement("td");
                td.textContent = data[data.length - 1][col];
                td.className = subHeadings[col];
                if (dollarValues.includes(subHeadings[col])) td.classList.add("currency");
                tr.appendChild(td);
            }
            tfoot.appendChild(tr);
            table.appendChild(tfoot);

            // Format currencies
            const values = document.getElementsByClassName("currency");
            for (let i = 0; i < values.length; i++) {
                values[i].textContent = parseFloat(values[i].textContent).toLocaleString('en-NZ', { style: 'currency', currency: 'NZD' });
            }

            document.getElementById('copyright').hidden = false;
            document.getElementById('screenshotBtn').hidden = false;
            positionScreenBtn();
        }

        // Take screenshot
        document.getElementById('screenshotBtn').addEventListener('click', async () => {
            const element = document.getElementById('capture');
            const canvas = await html2canvas(element);
            canvas.toBlob(async (blob) => {
                try {
                    await navigator.clipboard.write([
                        new ClipboardItem({ [blob.type]: blob })
                    ]);
                } catch (err) {
                    console.error('Failed to copy screenshot:', err);
                }
            });
        });

        // Position screenshot button
        function positionScreenBtn() {
            const ref = document.getElementById('kpi-table');
            const float = document.getElementById('screenshotBtn');
            const rect = ref.getBoundingClientRect();

            float.style.top = `${window.scrollY + rect.top - float.offsetHeight - 5}px`;
            float.style.left = `${window.scrollX + rect.right - float.offsetWidth - 5}px`;
        }

        window.addEventListener('load', positionScreenBtn);
        window.addEventListener('resize', positionScreenBtn);
        window.addEventListener('scroll', positionScreenBtn);
        document.querySelector('#file-input').onchange = function () {
            document.getElementById('file-selected').innerText = this.files[0]?.name;
        }
    </script>
    <script>
        // -------------------------------------------------------------------------------------------------------------------------

        // Loan Phone Audit

        var available = [];
        var allocated = [];

        // Event listener for scanner
        document.getElementById("scan").addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
                const scanned = document.getElementById("scan");

                let device = available.find(d => d['Serial#'] == scanned.value) || allocated.find(d => d['Serial#'] == scanned.value);
                if (!device) {
                    if (scanned.value) { console.log("Scanned IMEI not found"); }
                } else {
                    document.getElementById(scanned.value).innerText = "Yes";
                }

                scanned.value = "";
            }
        });

        function displayAudit(jsonData) {
            available = [];
            allocated = [];
            jsonData.forEach(device => {
                if (device.Availability == "Available") {
                    available.push(device);
                } else if (device.Availability == "Allocated") {
                    allocated.push(device);
                } else {
                    console.log("Could not find availability for device:" + device);
                }
            });

            const avTableBody = document.getElementById('av-tbody');
            avTableBody.innerHTML = "";
            available.forEach(a => {
                const id = a["Serial#"];
                const tr = document.createElement('tr');

                const item = document.createElement('td');
                item.textContent = a["Item"];
                tr.appendChild(item);

                const imei = document.createElement('td');
                imei.textContent = id;
                tr.appendChild(imei);

                const name = document.createElement('td');
                name.textContent = a["Serial Description"];
                tr.appendChild(name);

                const scanned = document.createElement('td');
                scanned.textContent = "No";
                scanned.id = id;
                tr.appendChild(scanned);

                const condition = document.createElement('td');
                const usable = document.createElement('input');
                usable.type = "radio";
                usable.id = `g${id}`;
                usable.name = `gb${id}`;
                usable.value = `g${id}`;
                const usableLabel = document.createElement('label');
                usableLabel.htmlFor = `g${id}`;
                usableLabel.innerText = "Usable";
                const unusable = document.createElement('input');
                unusable.type = "radio";
                unusable.id = `b${id}`;
                unusable.name = `gb${id}`;
                unusable.value = `b${id}`;
                const unusableLabel = document.createElement('label');
                unusableLabel.htmlFor = `b${id}`;
                unusableLabel.innerText = "Unusable";
                condition.appendChild(usable);
                condition.appendChild(usableLabel);
                condition.appendChild(unusable);
                condition.appendChild(unusableLabel);
                tr.appendChild(condition)

                avTableBody.appendChild(tr);
            });

            const alTableBody = document.getElementById('al-tbody');
            alTableBody.innerHTML = "";
            allocated.forEach(a => {
                const id = a["Serial#"];
                const tr = document.createElement('tr');

                const item = document.createElement('td');
                item.textContent = a["Item"];
                tr.appendChild(item);

                const imei = document.createElement('td');
                imei.textContent = id;
                tr.appendChild(imei);

                const name = document.createElement('td');
                name.textContent = a["Serial Description"];
                tr.appendChild(name);

                const scanned = document.createElement('td');
                scanned.textContent = "No";
                scanned.id = id;
                tr.appendChild(scanned);

                const date = document.createElement('td');
                const datePicker = document.createElement('input');
                datePicker.type = "date";
                date.id = `d${id}`;
                date.appendChild(datePicker);
                tr.appendChild(date);

                alTableBody.appendChild(tr);
            });

            // // Display the data
            // document.getElementById('output').textContent = JSON.stringify(available, null, 2);
            // document.getElementById('output').textContent += JSON.stringify(allocated, null, 2);
        }
    </script>
    <script>
        // -------------------------------------------------------------------------------------------------------------------------

        // SIM Swap template form

        var name = "";
        var contact = "";
        var idtype = "";
        var idby = "";
        const secquestions = document.getElementById("secquestions");
        const questiontoggle = document.getElementsByClassName("questiontoggle");
        const secqs = document.querySelectorAll(".oaq, .ppq");
        var reason = "";
        var approver = "";
        var template = document.getElementById("template");
        var charcount = document.getElementById("charcount");

        function nameChg(val) {
            name = val;
            editTemplate();
        }

        function contactChg(val) {
            contact = val;
            editTemplate();
        }

        function idtypeChg(val) {
            idtype = val;
            editTemplate();
        }

        function pinChg(val) {
            idby = val;
            if (val == "pin" || val == "otp") {
                secquestions.hidden = true;
                Array.from(secqs).forEach(q => {
                    q.firstElementChild.checked = false;
                });
            } else {
                secquestions.hidden = false;
            }
            editTemplate();
        }

        function reasonChg(val) {
            reason = val;
            editTemplate();
        }

        function approverChg(val) {
            approver = val;
            editTemplate();
        }

        function secqChg(val) {
            Array.from(secqs).forEach(q => {
                if (val == "oa" && q.className == "oaq") {
                    q.hidden = false;
                } else if (val == "pp" && q.className == "ppq") {
                    q.hidden = false;
                } else {
                    q.hidden = true;
                }
                q.firstElementChild.checked = false;
            });
            editTemplate();
        }

        function editTemplate() {
            let t = template.innerHTML;
            let n = name;
            let c = "";
            if (contact == "accholder") {
                c = "Acc Holder";
            } else if (contact == "authcontact") {
                c = `Auth Contact\nAcc Holder Contacted:Y`;
            }
            let idt = "";
            switch (idtype) {
                case "nzdl":
                    idt = "NZDL";
                    break;
                case "nzpp":
                    idt = "NZ Passport";
                    break;
                case "auspp":
                    idt = "Aus Passport";
                    break;
                case "otherpp":
                    idt = "Overseas Passport";
                    break;
                case "nzbc":
                    idt = "Birth cert & bank statement";
                    break;
                case "coi":
                    idt = "Cert of identity";
                    break;
                case "kac":
                    idt = "Kiwi Access & bank statement";
                    break;
                case "18p":
                    idt = "18+ & bank statement";
                    break;
            }
            let sqs = "";
            Array.from(secqs).forEach(q => {
                if (q.firstElementChild.checked) {
                    if (sqs != "") { sqs += ", "; }
                    sqs += q.firstElementChild.value;
                }
            });
            let idb = "";
            if (idby == "pin") {
                idb = "PIN";
            } else if (idby == "otp") {
                idb = "OTP";
            } else if (idby == "secq") {
                idb = `Sec Qs\nQs asked:${sqs}`;
            }

            let r = reason;
            let a = approver;
            t = `Full name:${n}\nAcc Holder/Auth Contact:${c}\nID Type:${idt}\nID'd by:${idb}\nSwap reason:${r}\nApproved by:${a}`;
            template.value = t;

            charcount.innerText = template.value.length;

            const b = document.getElementById("copytext");
            const sqc = document.getElementById("seccount");

            let e = true;
            if (!n || !c || !idt || !idb || !r || !a) e = false;
            if (idby == "secq") {
                let scount = 0;
                Array.from(secqs).forEach(q => {
                    if (q.firstElementChild.checked) {
                        scount += 1;
                    }
                })
                if (scount < 2) {
                    e = false;
                }
                sqc.innerText = ` | Question count: ${scount}/2`;
            } else {
                sqc.innerText = "";
            }
            b.disabled = !e;
        }

        function copyToClipboard() {
            navigator.clipboard.writeText(template.value)
                .catch(err => alert("Failed to copy text: " + err));
        }
    </script>
</body>

</html>

